pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        SECRET = credentials('SECRET')
        MAIL_SECRET = credentials('MAIL_SECRET')
        ACCOUNTS_CLIENT_SECRET = credentials('ACCOUNTS_CLIENT_SECRET')
        FRONT_CLIENT_SECRET = credentials('FRONT_CLIENT_SECRET')
        CASH_CLIENT_SECRET = credentials('CASH_CLIENT_SECRET')
        TRANSFER_CLIENT_SECRET = credentials('TRANSFER_CLIENT_SECRET')
        NOTIFICATIONS_CLIENT_SECRET = credentials('NOTIFICATIONS_CLIENT_SECRET')
        IMAGE_TAG = 0.0.1
    }

    stages {
        stage('Build Services') {
            stage('bootJar') {
                steps {
                    dir('bankapp') {
                        sh './gradlew bootJar'
                    }
                }
            }
            parallel {
                stage('Build Accounts') {
                    steps {
                        dir('bankapp') {
                            sh 'docker build -t ${DOCKER_REGISTRY}/accounts:${IMAGE_TAG} .'
                        }
                    }
                }
                stage('Build Cash') {
                    steps {
                        dir('bankapp') {
                            sh 'docker build -t ${DOCKER_REGISTRY}/cash:${IMAGE_TAG} .'
                        }
                    }
                }
                stage('Build Transfer') {
                    steps {
                        dir('bankapp') {
                            sh 'docker build -t ${DOCKER_REGISTRY}/transfer:${IMAGE_TAG} .'
                        }
                    }
                }
                stage('Build Notifications') {
                    steps {
                        dir('bankapp') {
                            sh 'docker build -t ${DOCKER_REGISTRY}/notifications:${IMAGE_TAG} .'
                        }
                    }
                }
                stage('Build Front') {
                    steps {
                        dir('bankapp') {
                            sh 'docker build -t ${DOCKER_REGISTRY}/front:${IMAGE_TAG} .'
                        }
                    }
                }
            }
        }

        stage('Push Images') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'GHCR_TOKEN', variable: 'GHCR_TOKEN')]) {
                        sh """
                            echo \$GHCR_TOKEN | docker login ghcr.io -u ${GITHUB_USERNAME} --password-stdin

                            docker push ${DOCKER_REGISTRY}/accounts:${IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/cash:${IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/transfer:${IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/notifications:${IMAGE_TAG}
                            docker push ${DOCKER_REGISTRY}/front:${IMAGE_TAG}
                        """
                    }
                }
            }
        }

        stage('Update Dependencies') {
            steps {
                script {
                    echo "Updating Helm dependencies..."
                        sh """
                            helm dependency update bankapp-chart
                        """
                }
            }
        }

        stage('Create Secrets for TEST') {
            steps {
                script {
                    sh """
                        kubectl create namespace test --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic accounts-secrets \
                            --namespace=test \
                            --from-literal=datasource-username=${SECRET} \
                            --from-literal=datasource-password=${SECRET} \
                            --from-literal=liquibase-user=${SECRET} \
                            --from-literal=liquibase-password=${SECRET} \
                            --from-literal=oauth2-client-secret=${ACCOUNTS_CLIENT_SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic cash-secrets \
                            --namespace=test \
                            --from-literal=oauth2-client-secret=${CASH_CLIENT_SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic transfer-secrets \
                            --namespace=test \
                            --from-literal=oauth2-client-secret=${TRANSFER_CLIENT_SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic notifications-secrets \
                            --namespace=test \
                            --from-literal=oauth2-client-secret=${NOTIFICATIONS_CLIENT_SECRET} \
                            --from-literal=mail-password=${MAIL_SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic front-secrets \
                            --namespace=test \
                            --from-literal=oauth2-client-secret=${FRONT_CLIENT_SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic postgresql-secrets \
                            --namespace=test \
                            --from-literal=postgres-password=${SECRET} \
                            --from-literal=password=${SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic keycloak-secrets \
                            --namespace=test \
                            --from-literal=postgres-password=${SECRET} \
                            --from-literal=password=${SECRET} \
                            --dry-run=client -o yaml | kubectl apply -f -

                        kubectl create secret generic kafka-secrets \
                          --namespace=bankapp \
                          --from-literal=cluster-id=${SECRET} \
                          --from-literal=controller-0-id=0 \
                          --from-literal=client-passwords=${SECRET} \
                          --from-literal=inter-broker-password=${SECRET} \
                          --from-literal=controller-password=${SECRET} \
                          --dry-run=client -o yaml | kubectl apply -f -
                        """
                    }
                }
            }
        }

        stage('Deploy Umbrella Chart for TEST') {
            steps {
                script {
                    sh """
                        helm upgrade --install bankapp . \
                            --namespace test \
                            --set accounts.image.repository=${DOCKER_REGISTRY}/accounts \
                            --set accounts.image.tag=${IMAGE_TAG} \
                            --set cash.image.repository=${DOCKER_REGISTRY}/cash \
                            --set cash.image.tag=${IMAGE_TAG} \
                            --set transfer.image.repository=${DOCKER_REGISTRY}/transfer \
                            --set transfer.image.tag=${IMAGE_TAG} \
                            --set notifications.image.repository=${DOCKER_REGISTRY}/notifications \
                            --set notifications.image.tag=${IMAGE_TAG} \
                            --set front.image.repository=${DOCKER_REGISTRY}/front \
                            --set front.image.tag=${IMAGE_TAG} \
                            --wait \
                            --timeout 600s
                    """
                    }
                }
            }
        }

        stage('Manual Approval for PROD') {
            steps {
                input message: 'Deploy to PROD environment?', ok: 'Yes, deploy'
            }
        }

        stage('Create Secrets for PROD') {
            steps {
                script {
                    sh """
                        kubectl create namespace prod

                        kubectl create secret generic accounts-secrets \
                            --namespace=prod \
                            --from-literal=datasource-username=${SECRET} \
                            --from-literal=datasource-password=${SECRET} \
                            --from-literal=liquibase-user=${SECRET} \
                            --from-literal=liquibase-password=${SECRET} \
                            --from-literal=oauth2-client-secret=${ACCOUNTS_CLIENT_SECRET}

                        kubectl create secret generic cash-secrets \
                            --namespace=prod \
                            --from-literal=oauth2-client-secret=${CASH_CLIENT_SECRET}

                        kubectl create secret generic transfer-secrets \
                            --namespace=prod \
                            --from-literal=oauth2-client-secret=${TRANSFER_CLIENT_SECRET}

                        kubectl create secret generic notifications-secrets \
                            --namespace=prod \
                            --from-literal=oauth2-client-secret=${NOTIFICATIONS_CLIENT_SECRET}

                        kubectl create secret generic front-secrets \
                            --namespace=prod \
                            --from-literal=oauth2-client-secret=${FRONT_CLIENT_SECRET}

                        kubectl create secret generic postgresql-secrets \
                            --namespace=prod \
                            --from-literal=postgres-password=${SECRET} \
                            --from-literal=password=${SECRET}

                        kubectl create secret generic keycloak-secrets \
                            --namespace=prod \
                            --from-literal=postgres-password=${SECRET} \
                            --from-literal=password=${SECRET}
                        """
                    }
                }
            }
        }

        stage('Deploy Umbrella Chart for PROD') {
            steps {
                script {
                    sh """
                        helm upgrade --install bankapp . \
                            --namespace prod \
                            --set accounts.image.repository=${DOCKER_REGISTRY}/accounts \
                            --set accounts.image.tag=${IMAGE_TAG} \
                            --set cash.image.repository=${DOCKER_REGISTRY}/cash \
                            --set cash.image.tag=${IMAGE_TAG} \
                            --set transfer.image.repository=${DOCKER_REGISTRY}/transfer \
                            --set transfer.image.tag=${IMAGE_TAG} \
                            --set notifications.image.repository=${DOCKER_REGISTRY}/notifications \
                            --set notifications.image.tag=${IMAGE_TAG} \
                            --set front.image.repository=${DOCKER_REGISTRY}/front \
                            --set front.image.tag=${IMAGE_TAG} \
                            --wait \
                            --timeout 600s
                    """
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                echo "BankApp deployment completed successfully!"
            }
        }
        failure {
            script {
                echo "BankApp deployment failed!"
            }
        }
        cleanup {
            script {
                cleanWs()
            }
        }
    }
}